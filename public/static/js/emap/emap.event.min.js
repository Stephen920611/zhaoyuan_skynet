window.emap=window.emap||{};emap.event=emap.event||{};emap.event={_eventHandler:null,_currPointArry:{},_operateCase:null,_hideDayOutNight:null,_firstAppear:null,latLngArray:null,mouseMove:function(a){document.getElementById("latAndLng").innerHTML=a.latLng.lng()+","+a.latLng.lat()},zoomChanged:function(b,a){document.getElementById("showZoom").innerHTML=b.getZoom()},overlayComplete:function(b){var a=this;var c=a._eventHandler;emap.main.drawingManager.setDrawingMode(null);if(emap.work._areaLine){emap.work._areaLine.setMap(null);emap.work._areaLine=b.overlay}if(c&&a._eventCallback[c]){a._eventCallback[c].call(a,b)}else{alert("未找到对应的形状类型！")}},initMap:function(){emap.event.doGetMapBounds();google.maps.event.addListener(emap.main.map,"zoom_changed",function(a){console.log("级别变化");emap.event.doGetMapBounds()});google.maps.event.addListener(emap.main.map,"dragend",function(a){console.log("拖动结束");emap.event.doGetMapBounds()});google.maps.event.addListener(emap.main.map,"click",function(c){var b=$(".main-content").attr("id");if(b=="commandControl"){var a=$("#manuallyLocate").attr("data-role");if(a=="true"){$("#lat-input").val(c.latLng.lat());$("#lng-input").val(c.latLng.lng())}}})},doGetMapBounds:function(f){var l=emap.main.map.getBounds().toJSON();var f=f?f:emap.event._currPointArry;console.log("**************",f);var j=0,i=0,h=0,g=0,e=0,b=0,a=0;var d=$("a#cameraMap").hasClass("active");var c=$("a#partsMap").hasClass("active");var k=$("a#roadMap").hasClass("active");var m=$("a#areaARMap").hasClass("active");$.each(f,function(n,o){if(l.south<=o.lat&&o.lat<=l.north&&l.west<=o.lng&&o.lng<=l.east){if(o.cameras!=undefined&&o.cameras.length>0&&o.type=="camera"){$.each(o.cameras,function(q,p){if(p.type==1){j++;if(p.status==1){b++}}else{if(p.type==3||p.type==4||p.type==5){i++;if(p.status==1){a++}}}})}if(o.cameras!=undefined&&o.cameras.length>0&&o.type=="AR"||o.type=="HIGH"){e++}if(o.components!=undefined&&o.components.length>0){$.each(o.components,function(q,p){if(p.type==1){h++}else{if(p.type==2){g++}}})}}});if($(".map-apply").attr("id")=="mapApply"){$("#firstTypeCamera").html(b+"/"+j);$("#secondTypeCamera").html(a+"/"+i);return}if(d){$("#firstTypeCamera").html(b+"/"+j);$("#secondTypeCamera").html(a+"/"+i)}else{if(k&&emap.drawEvent._pointArry.length>0){j=0;i=0;b=0;a=0;$.each(emap.drawEvent._pointArry,function(n,o){if(l.south<=o.lat&&o.lat<=l.north&&l.west<=o.lng&&o.lng<=l.east){if(o.cameras!=undefined&&o.cameras.length>0){$.each(o.cameras,function(q,p){if(p.type==1){j++;if(p.status==1){b++}}else{if(p.type==3||p.type==4||p.type==5){i++;if(p.status==1){a++}}}})}}});$("#firstTypeCamera").html(b+"/"+j);$("#secondTypeCamera").html(a+"/"+i)}else{$("#firstTypeCamera").html(0);$("#secondTypeCamera").html(0)}}if(c){$("#wifiMapNum").html(g);$("#wlMapNum").html(h)}else{if(k&&emap.drawEvent._pointArry.length>0){h=0;g=0;$.each(emap.drawEvent._pointArry,function(n,o){if(l.south<=o.lat&&o.lat<=l.north&&l.west<=o.lng&&o.lng<=l.east){if(o.components!=undefined&&o.components.length>0){$.each(o.components,function(q,p){if(p.type==1){h++}else{if(p.type==2){g++}}})}}});$("#wifiMapNum").html(g);$("#wlMapNum").html(h)}else{$("#wifiMapNum").html(0);$("#wlMapNum").html(0)}}if(m){$("#ARMapNum").html(e)}else{if(k&&emap.drawEvent._pointArry.length>0){e=0;$.each(emap.drawEvent._pointArry,function(n,o){if(l.south<=o.lat&&o.lat<=l.north&&l.west<=o.lng&&o.lng<=l.east){if(o.cameras!=undefined&&o.cameras.length>0&&o.type=="AR"||o.type=="HIGH"){e++}}});$("#ARMapNum").html(e)}else{$("#ARMapNum").html(0)}}},_getMarkersInRect:function(c,b,a){var h=[];var j=c.getKeys();maxLng=b.lng();minLng=a.lng();maxLat=b.lat();minLat=a.lat();var e;var g;var f;for(var d=0;d<j.length;d++){e=c.getValue(j[d]);g=e.getPosition().lng();f=e.getPosition().lat();if(g<maxLng&&g>minLng&&f<maxLat&&f>minLat){h.push(e.id)}}return h},openDrawHandle:function(b){console.log("endid",b);emap.work.clearOverlays();var a=this;$(".drawer-content").animate({right:"-11px"});$(".drawer-handle>ul>li>a").toggleClass("click");$("#choosenTab").click();$(".point-list").show();$.ajax({url:ext.impor.ajaxUrl+"/position/getInfoByIds",type:"GET",dataType:"json",data:{id:b.join(",")},success:function(g){var c=0;var d=g.cameras;console.log("cameras",d);var f=[];$.each(d,function(h,k){if(k.status==1){c++}var j="";if(k.type==1){j=k.status==1?"icon-spherical32":"icon-spherical32-n"}else{if(k.type==3){j=k.status==1?"icon-rifle32":"icon-rifle32-n"}}k.icon='<span class="'+j+'" id="'+k.code+'" data-type="'+k.type+'" data-name="'+k.des+'"></span>';f.push(k)});$(".cam-total").html(c+"/"+g.number);if(f.length!=0){var e={data:f,columns:[{width:"20px",align:"center",field:"checkbox",checkbox:true,checkboxHeader:false},{width:"30px",field:"icon"},{field:"des",align:"left"}],locale:"zh-CN",onCheck:function(i,h){},pagination:true,pageSize:10,pageList:[10]};$(".point-table").bootstrapTable(e);$(".point-table").bootstrapTable("load",f)}}})},openCaseDraw:function(c){var b=this;var a=$("#mapApply .info-list-div2").css("display");if(a=="none"){ext.main.notice("请先添加或编辑预案");return}$(".drawer-content").animate({right:"-11px"});$(".drawer-handle>ul>li>a").toggleClass("click");$("#videoCaseTab").click();$.ajax({url:ext.impor.ajaxUrl+"/position/getInfoByIds",type:"GET",dataType:"json",data:{id:c.join(",")},success:function(e){var d=e.cameras;$.each(d,function(h,k){var j="";if(k.type==1){j="../../static/img/spherical32.png"}else{j="../../static/img/rifle32.png"}var l=$(".info-list-div2 .camera-div").find(".camera-one");var f=l.length+1;var m='<div class="camera-one"><div class="cam-info" id="'+k.code+'" data-camera="'+k.code+"&"+k.des+"&"+k.type+'"  onclick="func.videoPlan.clickCamera(this)"><span class="cam-inx">'+f+'</span><img src="'+j+'"><p class="slh-1h" title="'+k.des+'">'+k.des+'</p><i class="fa fa-play"></i></div></div>';var g=[];$.each(l,function(n,i){g.push(i.id)});if($.inArray(k.code,g)>-1){ext.main.notice("请勿重复添加")}else{$(".info-list-div2 .camera-div").append(m)}})}})},openHideDayOutNight:function(a){console.log("endid",a);func.hideDayOutNight.tollgateIDs=a.join(",")},openFirstAppear:function(a){console.log("endid",a);func.firstAppear.tollgateIDs=a.join(",")},_eventCallback:{searchBayonetByPolygonComplete:function(f){console.log("shape",f);emap.work._tempOverlay=f.overlay;var n=f.overlay.getPath();var h=[];var a=emap.work._bayonetHash;var g;var e=[];var k=[];if(n){for(var b=0;b<n.length;b++){var m={};m.lat=n.getAt(b).lat();m.lng=n.getAt(b).lng();e.push(m);k.push(n.getAt(b))}}emap.event.latLngArray={type:"polygon",bounds:JSON.stringify(e)};if(a.getSize()>0){var l=a.getKeys();for(var d=0;d<l.length;d++){var c=a.getValue(l[d]);g=emap.util.isPointInPolygon(k,c);if(g){h.push(c.id)}}console.log("selectedMarkers1111",h);if(h.length>0){}else{console.log("选择的区域暂无路口信息，请重新绘制！")}}$.each(window.func,function(j,p){if(p._emapDrawCompleteCallFunc){var o=emap.event._pageCallBackHandler;console.log("callBackHandler",o);if(o){p._emapDrawCompleteCallFunc[o].call(p,JSON.stringify(e),h)}return false}})},markPointComplete:function(b){var e=b.overlay.getPosition();var c=e.lng();var d=e.lat();var a=b.overlay},searchByCircleComplete:function(h){emap.work._tempOverlay=h.overlay;var b=$(".map-apply").attr("id");if(!$("#cameraMap").hasClass("active")&&!b){ext.main.notice("请先打开摄像机开关再框选");emap.work.clearOverlays();return}var j=[];var f=[];var g=h.overlay.getRadius();var l=h.overlay.getCenter();emap.event.latLngArray={type:"circle",radius:g,center:l};var c=emap.work._cameraHash;var k=c.getKeys();console.log("@searchByCircleComplete-keys",k);if(k.length>0){var a;var e;for(var d=0;d<k.length;d++){e=c.getValue(k[d]);a=emap.util.getDistance(l,e.getPosition());if(a<g){j.push(e.id);f.push(e)}}console.log("selectAllmarker",f);if(emap.event._operateCase){this.openCaseDraw(j);emap.event._operateCase=null}else{if(emap.event._hideDayOutNight){this.openHideDayOutNight(j);emap.event._hideDayOutNight=null}else{if(emap.event._firstAppear){this.openFirstAppear(j);emap.event._firstAppear=null}else{if(j.length>0){this.openDrawHandle(j)}}}}}else{alert("暂无点位信息，请选择框选！")}},searchByRectComplete:function(a){console.log("shape",a);emap.work._tempOverlay=a.overlay;var d=$(".map-apply").attr("id");if(!$("#cameraMap").hasClass("active")&&!d){ext.main.notice("请先打开摄像机开关再框选");emap.work.clearOverlays();return}var e=emap.work._cameraHash;var c=a.overlay.getBounds();emap.event.latLngArray={type:"rect",bounds:c};if(e.getSize()>0){var b=this._getMarkersInRect(e,c.getNorthEast(),c.getSouthWest());if(emap.event._operateCase){this.openCaseDraw(b);emap.event._operateCase=null}else{if(emap.event._hideDayOutNight){this.openHideDayOutNight(b);emap.event._hideDayOutNight=null;return false}else{if(emap.event._firstAppear){this.openFirstAppear(b);emap.event._firstAppear=null}else{if(b.length>0){this.openDrawHandle(b)}}}}}else{alert("暂无小区点位信息，请选择小区后进行框选！")}},searchByPolygonComplete:function(f){emap.work._tempOverlay=f.overlay;var a=$(".map-apply").attr("id");if(!$("#cameraMap").hasClass("active")&&!a){ext.main.notice("请先打开摄像机开关再框选");emap.work.clearOverlays();return}var m=f.overlay.getPath();var h=[];var b=emap.work._cameraHash;var g;var k=[];if(m){for(var c=0;c<m.length;c++){k.push(m.getAt(c))}}emap.event.latLngArray={type:"polygon",bounds:k};if(b.getSize()>0){var l=b.getKeys();for(var e=0;e<l.length;e++){var d=b.getValue(l[e]);g=emap.util.isPointInPolygon(k,d);if(g){h.push(d.id)}}if(emap.event._operateCase){this.openCaseDraw(h);emap.event._operateCase=null}else{if(emap.event._hideDayOutNight){this.openHideDayOutNight(h);emap.event._hideDayOutNight=null}else{if(emap.event._firstAppear){this.openFirstAppear(h);emap.event._firstAppear=null}else{if(h.length>0){this.openDrawHandle(h)}}}}}else{alert("暂无小区点位信息，请选择小区后进行框选！")}},searchByLineComplete:function(l){emap.work._tempOverlay=l.overlay;var F=$(".map-apply").attr("id");if(!$("#cameraMap").hasClass("active")&&!F){ext.main.notice("请先打开摄像机开关再框选");emap.work.clearOverlays();return}var P=emap.work._cameraHash;var B;var d=[];if(P.getSize()>0){var A=l.overlay.getPath();var T=[];for(var N=0;N<A.length;N++){T.push(A.getAt(N))}emap.event.latLngArray={type:"line",bounds:T};var t=new Array();var r=new Array();for(var M=0;M<T.length-1;M++){var c=0.0001134;var b=0.0001134;var R=0;if(T[M+1].lng()==T[M].lng()){R=3.14/2}else{R=Math.atan((T[M+1].lat()-T[M].lat())/(T[M+1].lng()-T[M].lng()))}var k=T[M].lng()-c*Math.sin(R);var V=T[M].lat()+c*Math.cos(R);var h=T[M+1].lng()-b*Math.sin(R);var U=T[M+1].lat()+b*Math.cos(R);var g=T[M+1].lng()+b*Math.sin(R);var S=T[M+1].lat()-b*Math.cos(R);var e=T[M].lng()+c*Math.sin(R);var Q=T[M].lat()-c*Math.cos(R);var s=emap.main.getMapPoint(V,k);var o=emap.main.getMapPoint(U,h);var n=emap.main.getMapPoint(S,g);var m=emap.main.getMapPoint(Q,e);var O=(T[M+1].lng()-T[M].lng())*(V-T[M].lat())-(k-T[M].lng())*(T[M+1].lat()-T[M].lat());if(O>0){t.push(s);t.push(o);r.push(m);r.push(n)}else{t.push(m);t.push(n);r.push(s);r.push(o)}}var H="";var E=t.length;var C=r.length;if(E==2){H=t[0].lng()+","+t[0].lat()+","+t[1].lng()+","+t[1].lat()+","+r[1].lng()+","+r[1].lat()+","+r[0].lng()+","+r[0].lat()+","+t[0].lng()+","+t[0].lat()}else{for(var N=0;N<E/2-1;N++){var L=2*N;H=H+t[L].lng()+","+t[L].lat()+",";var z=(t[L].lat()-t[L+1].lat())/(t[L].lng()-t[L+1].lng());var w=(t[L+2].lat()-t[L+3].lat())/(t[L+2].lng()-t[L+3].lng());var I=(z*t[L].lng()-w*t[L+2].lng()+t[L+2].lat()-t[L].lat())/(z-w);var G=t[L].lat()+(I-t[L].lng())*z;H=H+I+","+G+","}H=H+t[E-1].lng()+","+t[E-1].lat()+",";for(var M=C/2-2;M>-1;M--){var K=M*2+3;H=H+r[K].lng()+","+r[K].lat()+",";var z=(r[K].lat()-r[K-1].lat())/(r[K].lng()-r[K-1].lng());var w=(r[K-2].lat()-r[K-3].lat())/(r[K-2].lng()-r[K-3].lng());var I=(z*r[K].lng()-w*r[K-2].lng()+r[K-2].lat()-r[K].lat())/(z-w);var G=r[K].lat()+(I-r[K].lng())*z;H=H+I+","+G+","}H=H+r[0].lng()+","+r[0].lat()+","+t[0].lng()+","+t[0].lat()}var v=H.split(",");var J=[];for(var N=0;N<v.length;N=N+2){J.push(emap.main.getMapPoint(v[N+1],v[N]))}var u=P.getKeys();for(var N=0;N<u.length;N++){var D=P.getValue(u[N]);B=emap.util.isPointInPolygon(J,D);if(B){d.push(D.id)}}if(emap.event._operateCase){this.openCaseDraw(d);emap.event._operateCase=null}else{if(emap.event._hideDayOutNight){this.openHideDayOutNight(d);emap.event._hideDayOutNight=null}else{if(emap.event._firstAppear){this.openFirstAppear(d);emap.event._firstAppear=null}else{if(d.length>0){this.openDrawHandle(d)}}}}}else{alert("暂无小区点位信息，请选择小区后进行框选！")}}}};