window.emap=window.emap||{};emap.work=emap.work||{};emap.work={_testhash:new ext.utility.hashTable(),_pointHash:new ext.utility.hashTable(),_cameraHash:new ext.utility.hashTable(),_componentHash:new ext.utility.hashTable(),_deviceHash:new ext.utility.hashTable(),_caseHash:new ext.utility.hashTable(),_policeHash:new ext.utility.hashTable(),_personHash:new ext.utility.hashTable(),_bellHash:new ext.utility.hashTable(),_bayonetHash:new ext.utility.hashTable(),_tempOverlay:null,defaultCheckedMarkerImg:"greenMarker",defaultUncheckedMarkerImg:"8",_clusterRange:new ext.utility.hashTable(),_clusterMarkers:[],_currentLabel:[],_clusterSubMarkers:[],_markIcon:null,_markChangeIcon:new Array(),_test:null,isFlag:true,searchByRect:function(){emap.event._eventHandler="searchByRectComplete";emap.main.setDrawModel("rectangle")},searchByCircle:function(){emap.event._eventHandler="searchByCircleComplete";emap.main.setDrawModel("circle")},searchByLine:function(){emap.event._eventHandler="searchByLineComplete";emap.main.setDrawModel("polyline")},searchByPolygon:function(){emap.event._eventHandler="searchByPolygonComplete";emap.main.setDrawModel("polygon")},clearOverlays:function(b){var a=this;b=b||a._tempOverlay;if(b){if($.isArray(b)){$.each(b,function(c,d){d.setMap(null);d=null})}else{b.setMap(null);b=null}}},addMarker:function(a,h,k,j,m,i,g,b,n){var e=new google.maps.LatLng(h,k);var d=emap.main.getMarker(a,h,k,j,m);if(j=="cameras32"){d.number=n();d.iconName="cameras32";emap.work.getClusterMarker(d,b)}var o=this;o._pointHash.add(a,d);var c=o.markTypeRel(i);if(c){c.add(a,d)}if((i=="person"||i=="device"||i=="case"||i=="police"||i=="bell"||i=="3d")&&n){var f=n();var l=emap.drawEvent.addLabelWithFont(h,k,m,15);d.label=l;d.content=f;o._currentLabel.push(l)}if(b){d.setMap(emap.main.getMap())}else{d.setMap(null)}google.maps.event.addListener(d,"click",function(p){emap.main.move2PointByEvent(p);emap.event.doGetMapBounds();$("div.layerbox_item div.departSelectPanel").addClass("display-none");if(i=="camera"||i=="component"||i=="ar"||i=="HIGH"){o.showMarkerInfo(a,d,g)}else{if(i=="person"||i=="device"||i=="case"||i=="police"||i=="policeAlarm"||i=="bell"||i=="3d"||i=="bayonet"){emap.main.showInfoWin(d,d.content)}else{if(i=="point"){o.showPointMarkerInfo(d,g)}}}if(i=="policeAlarm"){emap.main.setZoom(16);func.mapResJud.panCaseMap(d.id,d.code)}});google.maps.event.addListener(d,"dblclick",function(p){console.log("test")});google.maps.event.addListener(d,"rightclick",function(p){if(emap.work._followType&&emap.work._markerRightClkCallback){emap.work._markerRightClkCallback(d.id,d.title)}});google.maps.event.addListener(d,"mouseover",function(p){});google.maps.event.addListener(d,"dragend",function(q){var p='<button id="savelatlng'+a+'" class="gray medium button">保存新位置</button><button id="goondrag" class="gray medium button">继续拖拽</button><button id="stopdrag" class="gray medium button">取消操作</button>';emap.main.showInfoWin(d,p);$("body").on("click","#savelatlng"+a,function(r){d.setDraggable(false);emap.main.closeInfoWinDelay(100)});$("body").on("click","#goondrag",function(r){d.setDraggable(true);emap.main.closeInfoWinDelay(100)});$("body").on("click","#stopdrag",function(r){d.setDraggable(false);d.setPosition(e);emap.main.closeInfoWinDelay(100)})});return d},clusterCameraPoints:function(){var e=this._pointHash;var n=e.getSize();if(n>0){var c=new ext.utility.hashTable();var h=e.getValues();var b=new Array();var m=emap.work.getClusterRange(emap.main.getLevel());for(var l=0;l<h.length;l++){var r=h[l];var o=false;var f=m;var s=-1;for(var g=0;g<b.length;g++){var a=emap.util.getDistance(b[g],r.position);if(a<m&&a<f){f=a;s=g}}if(s!=-1){c.getValue(b[s]).push(r);o=true}if(!o){var d=new Array();d.push(r);c.add(r.position,d);b.push(r.position)}}if(b.length>0){this.clearClusterMarkers();this.clearClusterSubMarkers();this.clearCamMarkerIcon();var p=this;for(var l=0;l<b.length;l++){var q=c.getValue(b[l]);if(q.length==1){q[0].setMap(emap.main.getMap())}else{var k=emap.main.getGatherMarker(b[l].lat(),b[l].lng(),q);this._clusterMarkers.push(k)}}}}},initHashTables:function(){this._clusterRange.add(19,0);this._clusterRange.add(18,0);this._clusterRange.add(17,100);this._clusterRange.add(16,200);this._clusterRange.add(15,300);this._clusterRange.add(14,400)},clearClusterMarkers:function(){if(this._clusterMarkers.length>0){for(var a=0;a<this._clusterMarkers.length;a++){this._clusterMarkers[a].setMap(null)}this._clusterMarkers.length=0}},clearClusterSubMarkers:function(){if(this._clusterSubMarkers.length>0){for(var a=0;a<this._clusterSubMarkers.length;a++){this._clusterSubMarkers[a].setMap(null)}this._clusterSubMarkers.length=0}},clearCamMarkerIcon:function(){var b=this._pointHash.getValues();for(var a=0;a<b.length;a++){b[a].setMap(null)}},getClusterRange:function(b){var a=1000;if(this._clusterRange.containsKey(b)){a=this._clusterRange.getValue(b)}return a},setClusterSubMarkers:function(a){this._clusterSubMarkers=a},changePointIcon:function(b,a){this._markIcon=a.icon;this._markChangeIcon.push(a);this.restorePointIcon();a.setMap(null);a.icon=emap.main.getIcon(b);a.setMap(emap.main.getMap())},restorePointIcon:function(){var a=this._markChangeIcon;if(a){if(a.length>1){a[0].setMap(null);a[0].icon=this._markIcon;a[0].setMap(emap.main.getMap());a.shift()}}},clearAllLabel:function(){if(this._currentLabel){for(var a=0;a<this._currentLabel.length;a++){this._currentLabel[a].setMap(null)}}},clearMarker:function(b){var a=this._pointHash.getValue(b);a.setMap(null)},clearSpecialMarker:function(a){if(a){for(var b=0;b<a.length;b++){a[b].setMap(null)}}},clearAllMarker:function(){if(this._pointHash){var b=this._pointHash.getValues();for(var a=0;a<b.length;a++){b[a].setMap(null)}}},clearMarkerByGroup:function(c){var d=this.markTypeRel(c);var b=d.getValues();for(var a=0;a<b.length;a++){b[a].setMap(null)}},getAllMarkers:function(b){var a=this;var d=a.markTypeRel(b);var c=new Array();if(d&&d!=null){c=d.getValues()}return c},markTypeRel:function(b){var c=null;var a=this;switch(b){case"camera":c=a._cameraHash;break;case"component":c=a._componentHash;break;case"device":c=a._deviceHash;break;case"case":c=a._caseHash;break;case"police":c=a._policeHash;break;case"person":c=a._personHash;break;case"bell":c=a._bellHash;break;case"bayonet":c=a._bayonetHash;break;case"text":c=a._testhash;break}return c},playVideo:function(c,b){var a=null;if(b){a=b}else{a=$(c).parent().children("p").html()}$("#videoArea h4.modal-title").html(a);$("#videoArea").draggable();$("#videoArea").modal({backdrop:false,show:true})},showMarkerInfo:function(d,b,a){$.ajax({url:ext.impor.ajaxUrl+"/position/getInfoById",type:"GET",data:{id:d},dataType:"json",success:function(i){console.log("@@@@",i,$.parseJSON(localStorage.getItem("power")));var q=parseFloat(i.lat).toFixed(4);var s=parseFloat(i.lng).toFixed(4);var j="";if(localStorage.getItem("power")){var f=$.parseJSON(localStorage.getItem("power")).addDeviceTag;j=(!f||f==0)?"none":"inline-block"}var n='<div class="loc-content"><div class="loca-info">位置信息</div><div class="msg-content"><p class="msg-info"><span>地理位置：</span><span class="loc-txt camera-des" title="'+i.des+'">'+i.des+'</span></p><p>所属区域：<span class="user-txt">'+i.areaName+'</span></p><p><span class="loca"><i class="fa fa-square"></i>E<span class="loc-lng">'+s+'</span></span><span class="loca"><i class="fa fa-square"></i>N<span class="loc-lat">'+q+"</span></span></p></div>";if(i.cameras.length!=0){var h="";if($(".map-apply").attr("id")=="mapApply"){h='<i class="fa fa-exclamation-triangle" title="纠错" data-id="'+i.cameras[0].id+'" onclick="func.mapOperation.correctError(this)"></i><i class="fa fa-cogs" title="添加预案" data-code="'+i.cameras[0].code+'" data-text="'+i.cameras[0].des+'" data-id="'+i.cameras[0].id+'" data-type="'+i.cameras[0].type+'"  onclick="func.mapOperation.addTv(this)"></i>'}if($(".main-content").attr("id")=="structPoint"){h='<i class="fa fa-paper-plane" title="申请" data-id="'+i.cameras[0].id+'"  data-code="'+i.cameras[0].code+'" data-des="'+i.cameras[0].des+'" onclick="func.mapOperation.applyStructPoint(this)"></i>'}if($(".main-content").attr("id")=="commandControl"){h='<i class="fa fa-tags" style="display: '+j+'" title="标签设定" data-id="'+i.cameras[0].id+'"  data-code="'+i.cameras[0].code+'" data-des="'+i.cameras[0].des+'" onclick="func.mapOperation.addCamToLabel(this)"></i><i class="fa info-monitor"  title="信息监测" data-id="'+i.cameras[0].code+'" onclick="func.commandControl.infoMonitor(this)"></i>'}var t=[];$.each(i.cameras,function(u,v){t.push(v.code+"&"+v.des+"&"+v.type)});var m=t.join(",");$("#videoCfg .all-video").data("camera",m);$("#videoCfg .all-playback").data("camera",m);var k=(b.buildStatus!=1)?"none":"block";n+='<div class="icon-wrap" style="display: '+k+'">';if(t.length==1){n+='<i class="fa fa-eye" title="查看" data-id="'+i.cameras[0].id+'"  onclick="func.mapOperation.viewCameraInfo(this)"></i><i class="fa fa-play-circle" title="实时预览" data-camera="'+m+'" onclick="func.mapOperation.clickRealPlay(this)"></i><i class="fa fa-youtube-play" title="录像回放" data-code="'+i.cameras[0].code+'" data-name="'+i.cameras[0].des+'" data-type="'+i.cameras[0].type+'" onclick="func.mapOperation.clickPlayBack(this)"></i><i class="fa fa-undo" title="单路多轨回放" data-code="'+i.cameras[0].code+'" data-name="'+i.cameras[0].des+'" data-type="'+i.cameras[0].type+'" onclick="func.mapOperation.clickMultPlay(this)"></i><i class="fa fa-video-camera" title="周边视频" onclick="func.mapOperation.clickRoundVideo()"></i>'+h+"</div>"}}n+="</div>";$("div.layerbox_item div.departSelectPanel").addClass("display-none");emap.main.showInfoWin(b,n);$("#pointInfo .loc-txt").html(i.areaName);$("#pointInfo .user-txt").html(i.des);$("#pointInfo .loc-lat").html(q);$("#pointInfo .loc-lng").html(s);var r=i.cameras;var e=i.type;if($(".main-content").attr("id")=="commandControl"&&e=="AR"){var o=localStorage.getItem("cloud_defense");func.mapOperation.openARClient(o)}var g="";$.each(r,function(x,z){if(z.buildStatus==b.buildStatus){var u=z.status==1?"在线":"离线";var w=(z.DHDeviceCode&&z.DHDeviceCode!="")?"inline-block":"none";var y="",v="";if($(".map-apply").attr("id")=="mapApply"){y='<i class="fa fa-exclamation-triangle" title="纠错" data-id="'+z.id+'" onclick="func.mapOperation.correctError(this)"></i><i class="fa fa-cogs" title="添加预案"  data-code="'+z.code+'" data-text="'+z.des+'" data-id="'+z.id+'" data-type="'+z.type+'"  onclick="func.mapOperation.addTv(this)"></i>'}if($(".main-content").attr("id")=="structPoint"){y='<i class="fa fa-paper-plane" title="申请" data-id="'+i.cameras[0].id+'"  data-code="'+i.cameras[0].code+'" data-des="'+i.cameras[0].des+'" onclick="func.mapOperation.applyStructPoint(this)"></i>'}if($(".main-content").attr("id")=="commandControl"){y='<i class="fa fa-tags" style="display: '+j+'" title="标签设定" data-id="'+i.cameras[0].id+'"  data-code="'+i.cameras[0].code+'" data-des="'+i.cameras[0].des+'" onclick="func.mapOperation.addCamToLabel(this)"></i><i class="info-monitor" title="信息监测" data-id="'+z.code+'" onclick="func.commandControl.infoMonitor(this)"></i>'}if($(".main-content").attr("id")=="commandControl"&&e=="AR"){v='<i class="ar-icon" style="display: '+w+'" title="AR视频" data-code="'+z.DHDeviceCode+'" onclick="func.mapOperation.openARCLientVideo(this)"></i>'}g+='<div><div class="check-cameras"  data-code="'+z.code+'" data-des="'+z.des+'" data-type="'+z.type+'"><input type="checkbox" checked></div><div class="check-content"><div class="dev-wrap"><div class="pic-wrap"><img src="'+(z.pic==undefined?"../../static/img/dev_pic.png":z.pic)+'"></div><div class="info-wrap"><p><span>点位名称：</span><span title="'+z.des+'" class="camera-des">'+z.des+"</span></p><p><span>点位类别：</span><span>"+z.monitorType+"</span></p><p><span>设备状态：</span><span>"+u+"</span></p><p><span>国标编码：</span><span>"+z.code+'</span></p></div></div><div class="icon-wrap" style="display: '+k+'">'+v+'<i class="fa fa-eye" title="查看" data-id="'+z.id+'"  onclick="func.mapOperation.viewCameraInfo(this)"></i><i class="fa fa-play-circle" title="实时预览" data-camera="'+z.code+"&"+z.des+"&"+z.type+'" onclick="func.mapOperation.clickRealPlay(this)"></i><i class="fa fa-youtube-play" title="录像回放" data-code="'+z.code+'" data-name="'+z.des+'" data-type="'+z.type+'" onclick="func.mapOperation.clickPlayBack(this)"></i><i class="fa fa-undo" title="单路多轨回放" data-code="'+z.code+'" data-name="'+z.des+'" data-type="'+z.type+'" onclick="func.mapOperation.clickMultPlay(this)"></i><i class="fa fa-video-camera" title="周边视频" onclick="func.mapOperation.clickRoundVideo()"></i> '+y+"</div></div></div>"}});$("#devList").html(g);if(r.length==0){$("#videoCfg").hide()}else{$("#videoCfg").show()}var l=i.components;var p="";$.each(l,function(u,v){p+='<div><div class="check-cameras" ></div><div class="check-content"><div class="dev-wrap"><div class="pic-wrap"><img src="'+(v.type==2?"../../static/img/wifi.png":"../../static/img/wl.png")+'"></div><div class="info-wrap"><p><span>点位名称：</span><span title="'+v.des+'" class="camera-des">'+v.des+"</span></p><p><span>部件类别：</span><span>"+v.typeName+"</span></p><p><span>点位状态：</span><span>"+v.buildStatus+'</span></p></div></div><div class="icon-wrap"><i class="fa fa-eye" title="查看" style="display: none"></i></div></div></div>'});$("#devList").append(p);if(a){$(".drawer-content").animate({right:"-11px"});$(".drawer-handle>ul>li>a").toggleClass("click");$("#pointTab").click()}}});if($(".manager-sys").attr("id")=="mapResJud"){func.mapOperation.camArry=emap.work.getAreaCamera(500,b)}if(b.type=="spherical32"&&func.videoPlan){var c=b.position}},showPointMarkerInfo:function(b,a){var e=b.data;var d="";var f=[];$.each(e.cameras,function(i,h){var g=func.analysisPoint.pointInfoHash.getValue(h.id).statusName;var l=func.analysisPoint.pointInfoHash.getValue(h.id).updateTime.substring(0,19);var k=func.analysisPoint.pointInfoHash.getValue(h.id).userName;d+='<div><div class="check-cameras" data-code="'+h.code+'" data-des="'+h.des+'" data-type="'+h.type+'" ><input type="checkbox" checked=""></div><div class="check-content"><div class="loc-cont dev-info"><div class="msg-cont"><p class="camera-info"><span class="loc-label">摄像机名称：</span><span class="loc-txt" title="'+h.des+'">'+h.des+'</span></p><p class="camera-info"><span class="loc-label">所属部门：</span><span class="loc-txt">'+h.organName+'</span></p><p class="camera-info"><span class="loc-label">状态：</span><span class="camera-state-1">'+g+'</span></p></div><div class="msg-btn"><span data-name="实时展示" data-camera="'+k+"&"+l.substring(0,19)+"&"+h.code+"&"+h.des+"&"+h.type+'"  onclick="func.analysisPoint.getRealTimeDetail(this)">实时展示</span><span data-name="历史结果" data-camera="'+h.code+"&"+h.des+'" onclick="func.analysisPoint.getHistoryResultDetail(this)">历史结果</span></div></div></div></div>';f.push(h.code+"&"+h.des+"&"+h.type)});$("#devList").html(d);var c=f.join(",");$("#videoCfg .all-video").data("camera",c);$("#videoCfg .all-playback").data("camera",c);emap.main.showInfoWin(b,b.content);if(a){$(".drawer-content").animate({right:"-11px"});$(".drawer-handle>ul>li>a").toggleClass("click");$("#pointTab").click()}},getAreaCamera:function(h,g){var d=emap.work._cameraHash;var j=d.getKeys();var b,c;var f=[];var a=[];for(var e=0;e<j.length;e++){c=d.getValue(j[e]);b=emap.util.getDistance(g.getPosition(),c.getPosition());if(b<h){f.push(j[e])}}$.ajax({url:ext.impor.ajaxUrl+"/position/getInfoByIds",type:"GET",dataType:"json",data:{id:f.join(",")},success:function(k){var i=k.cameras;$.each(i,function(l,m){a.push({code:m.code,text:m.des,typeCode:m.type})})}});return a},getRoundCamera:function(j,g){emap.drawEvent.clearCircle();var d=emap.work._cameraHash;var k=d.getKeys();var b,c;var e=[];for(var f=0;f<k.length;f++){c=d.getValue(k[f]);b=emap.util.getDistance(g.getPosition(),c.getPosition());if(b<j){c.setMap(emap.main.getMap());if(c.iconName=="cameras32"){c.labelMarker.setVisible(true)}e.push(k[f])}else{c.setMap(null);if(c.iconName=="cameras32"){c.labelMarker.setVisible()}}}if(e.length==0){alert("周边"+j+"米无摄像机")}else{ext.main.initLoading("读取中，请稍等...");$(".drawer-content").animate({right:"-11px"});$(".drawer-handle>ul>li>a").toggleClass("click");$("#choosenTab").click();var a=[];$.ajax({url:ext.impor.ajaxUrl+"/position/getInfoByIds",type:"GET",dataType:"json",data:{id:e.join(",")},success:function(p){var l=0;var m=p.cameras;var o=[];var i="";$.each(m,function(q,t){if(t.status==1){l++}var r="";if(t.type==1){r=t.status==1?"icon-spherical32":"icon-spherical32-n"}else{if(t.type==3){r=t.status==1?"icon-rifle32":"icon-rifle32-n"}}if(!t.sceneUrl){i=""}else{i=t.sceneUrl}var u=$(".case-info:first").siblings().text();var v=$(".loc-txt").data("code");var s=$(".alarm-cont").data("content");t.icon='<span class="'+r+'" id="'+t.code+'" data-type="'+t.type+'" data-time="'+u+'" data-content="'+s+'" data-id="'+v+'" data-positionId="'+t.positionId+'" data-img="'+i+'" data-name="'+t.des+'"></span>';o.push(t);a.push({code:t.code,text:t.des,typeCode:t.type,type:"camera"})});$(".cam-total").html(l+"/"+p.number);if(o.length!=0){var n={data:o,columns:[{width:"20px",align:"center",field:"checkbox",checkbox:true,checkboxHeader:false},{width:"30px",field:"icon"},{field:"des",align:"left"}],locale:"zh-CN",onCheck:function(r,q){},pagination:true,pageSize:10,pageList:[10]};$(".point-table").bootstrapTable(n);$(".point-table").bootstrapTable("load",o);ext.main.removeLoading()}}})}var h={radius:j,center:g.getPosition()};emap.drawEvent.drawCircle(h);return a},getClusterMarker:function(c,b){var f=emap.extension.getMarkerLabel(google.maps);var e=emap.main.getIcon("blank");var d=c.getPosition();var a=document.createElement("span");a.title="摄像机数量："+c.number;a.style.color="white";a.style["font-size"]="13px";a.style["text-align"]="center";a.innerHTML=c.number;var g=new f({position:d,map:emap.main.getMap(),draggable:false,raiseOnDrag:true,icon:e,labelContent:a,labelAnchor:new google.maps.Point(-12,40),labelClass:"marker-label",labelInBackground:false});c.labelMarker=g;if(b){c.labelMarker.setVisible(true)}else{c.labelMarker.setVisible()}}};emap.work.initHashTables();